@page "/projects/create"
@using Frontend.Services
@attribute [Authorize]
@inject IProjectService ProjectService
@inject NavigationManager Navigation
@inject NotificationService NotificationService

<PageTitle>Create Project</PageTitle>

<RadzenStack Gap="2rem" Style="padding: 2rem;">
    <RadzenRow JustifyContent="JustifyContent.Center">
        <RadzenColumn Size="12" SizeMD="10" SizeLG="8">
            <RadzenCard>
                <RadzenStack Gap="1.5rem">
                    <RadzenText TextStyle="TextStyle.H4">Create New Project</RadzenText>
                    
                    <EditForm Model="@createRequest" OnValidSubmit="HandleSubmit">
                        <DataAnnotationsValidator />
                        
                        <RadzenStack Gap="1rem">
                            <RadzenFormField Text="Project Name" Variant="Variant.Outlined">
                                <ChildContent>
                                    <RadzenTextBox @bind-Value="createRequest.Name" Style="width: 100%;" />
                                </ChildContent>
                                <Helper>
                                    <ValidationMessage For="@(() => createRequest.Name)" />
                                </Helper>
                            </RadzenFormField>

                            <RadzenFormField Text="Project Link (Optional)" Variant="Variant.Outlined">
                                <ChildContent>
                                    <RadzenTextBox @bind-Value="createRequest.ProjectLink" Style="width: 100%;" />
                                </ChildContent>
                                <Helper>
                                    <ValidationMessage For="@(() => createRequest.ProjectLink)" />
                                </Helper>
                            </RadzenFormField>

                            <RadzenFormField Text="Description (Optional)" Variant="Variant.Outlined">
                                <ChildContent>
                                    <RadzenTextArea @bind-Value="createRequest.Description" Rows="4" Style="width: 100%;" />
                                </ChildContent>
                                <Helper>
                                    <ValidationMessage For="@(() => createRequest.Description)" />
                                </Helper>
                            </RadzenFormField>

                            <RadzenFormField Text="Approver Name" Variant="Variant.Outlined">
                                <ChildContent>
                                    <RadzenTextBox @bind-Value="createRequest.ApproverName" Style="width: 100%;" />
                                </ChildContent>
                                <Helper>
                                    <ValidationMessage For="@(() => createRequest.ApproverName)" />
                                </Helper>
                            </RadzenFormField>

                            <RadzenFormField Text="Number of Milestones" Variant="Variant.Outlined">
                                <ChildContent>
                                    <RadzenNumeric @bind-Value="createRequest.NumberOfMilestones" Min="1" Style="width: 100%;" />
                                </ChildContent>
                                <Helper>
                                    <ValidationMessage For="@(() => createRequest.NumberOfMilestones)" />
                                </Helper>
                            </RadzenFormField>

                            <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" Style="margin-top: 1rem;">
                                <RadzenButton ButtonType="ButtonType.Submit" Text="Create Project" Icon="add_circle" 
                                              ButtonStyle="ButtonStyle.Primary" Disabled="@isLoading" />
                                <RadzenButton Text="Cancel" Icon="cancel" ButtonStyle="ButtonStyle.Light" 
                                              Click="@(() => Navigation.NavigateTo("/projects"))" />
                            </RadzenStack>
                        </RadzenStack>
                    </EditForm>
                </RadzenStack>
            </RadzenCard>
@code {
    private CreateProjectRequest createRequest = new() { NumberOfMilestones = 1 };
    private bool isLoading = false;

    private async Task HandleSubmit()
    {
        isLoading = true;

        try
        {
            var result = await ProjectService.CreateProject(createRequest);

            if (result != null)
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Success,
                    Summary = "Success",
                    Detail = "Project created successfully!",
                    Duration = 4000
                });
                await Task.Delay(1000);
                Navigation.NavigateTo($"/projects/{result.Id}");
            }
            else
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Error",
                    Detail = "Failed to create project. Please check the browser console for details.",
                    Duration = 4000
                });
            }
        }
        catch (HttpRequestException httpEx)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Network Error",
                Detail = $"{httpEx.Message}. Make sure the backend API is running.",
                Duration = 4000
            });
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Error",
                Detail = $"An error occurred: {ex.Message}",
                Duration = 4000
            });
            Console.WriteLine($"Full error: {ex}");
        }
        finally
        {
            isLoading = false;
        }
    }
}       {
            isLoading = false;
        }
    }
}
